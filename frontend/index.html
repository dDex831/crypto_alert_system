<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Alert Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <!-- å°è¦½åˆ— -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Crypto Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" data-tab="price" href="#">åƒ¹æ ¼è¨­å®š</a></li>
          <li class="nav-item"><a class="nav-link" data-tab="trades" href="#">äº¤æ˜“ç´€éŒ„</a></li>
          <li class="nav-item"><a class="nav-link" data-tab="news" href="#">æ–°èæ‘˜è¦</a></li>
          <li class="nav-item"><a class="nav-link" data-tab="tools" href="#">ç­†è¨˜ç®¡ç†</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- åƒ¹æ ¼è¨­å®šå€ -->
    <section id="price" class="tab-content">
      <h3>åƒ¹æ ¼è¿½è¹¤è¨­å®š</h3>
      <form id="thresholdForm" class="row g-3">
        <div class="col-md-4">
          <label for="symbolInput" class="form-label">å¹£ç¨®</label>
          <input type="text" class="form-control" id="symbolInput" value="cardano">
        </div>
        <div class="col-md-4">
          <label for="lowInput" class="form-label">åƒ¹æ ¼ä¸‹é™</label>
          <input type="number" step="0.01" class="form-control" id="lowInput" value="0.5">
        </div>
        <div class="col-md-4">
          <label for="highInput" class="form-label">åƒ¹æ ¼ä¸Šé™</label>
          <input type="number" step="0.01" class="form-control" id="highInput" value="0.8">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">æ›´æ–°è¨­å®š</button>
        </div>
      </form>
      <hr>
      <h5>æœ€æ–°åƒ¹æ ¼</h5>
      <p id="latestPrice">--</p>
      <!-- TradingView 4H K ç·šåœ– -->
      <div id="chart" style="height:400px; margin-top:1rem;"></div>
      <script src="https://s3.tradingview.com/tv.js"></script>
      <script>
        new TradingView.widget({
          container_id: 'chart',
          autosize: true,
          symbol: 'BINANCE:ADAUSDT',
          interval: '240',
          timezone: 'Asia/Taipei',
          theme: 'light',
          style: '1',
          locale: 'zh_TW',
          toolbar_bg: '#f1f3f6',
          enable_publishing: false,
          allow_symbol_change: false,
          hide_side_toolbar: false,
          details: true,
          hotlist: true
        });
      </script>
    </section>

    <!-- äº¤æ˜“ç´€éŒ„å€ -->
    <section id="trades" class="tab-content d-none">
      <h3>å¹£å®‰äº¤æ˜“ç´€éŒ„</h3>
      <table class="table table-striped" id="tradesTable">
        <thead>
          <tr><th>æ™‚é–“</th><th>å¹£ç¨®</th><th>è²·/è³£</th><th>åƒ¹æ ¼</th><th>æ•¸é‡</th><th>ç²åˆ©%</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- æ–°èæ‘˜è¦å€ -->
    <section id="news" class="tab-content d-none">
      <h3>æ¯æ—¥æ–°èæ‘˜è¦</h3>
      <div id="newsContainer"></div>
    </section>

    <!-- ç­†è¨˜ç®¡ç†å€ -->
    <section id="tools" class="tab-content d-none">
      <h3>ç­†è¨˜ç®¡ç†</h3>
      <button id="newNoteBtn" class="btn btn-success mb-3">æ–°å¢ç­†è¨˜</button>
      <div id="notesList"></div>
    </section>
  </div>

  <!-- ç­†è¨˜ç·¨è¼¯ Modal -->
  <div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="noteModalLabel">æ–°å¢ / ç·¨è¼¯ ç­†è¨˜</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="noteForm">
            <input type="hidden" id="noteId">
            <div class="mb-3">
              <label for="noteTitle" class="form-label">æ¨™é¡Œ</label>
              <input type="text" class="form-control" id="noteTitle" required>
            </div>
            <div class="mb-3">
              <label for="noteCode" class="form-label">ç¨‹å¼ç¢¼</label>
              <textarea class="form-control" id="noteCode" rows="4"></textarea>
            </div>
            <div class="mb-3">
              <label for="notePurpose" class="form-label">ç›®çš„</label>
              <textarea class="form-control" id="notePurpose" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="noteResult" class="form-label">çµæœ</label>
              <textarea class="form-control" id="noteResult" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">å„²å­˜</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle + è‡ªè¨‚ JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // åˆ†é åˆ‡æ›
    document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      e.target.classList.add('active');
      const tab = e.target.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(sec => sec.classList.add('d-none'));
      document.getElementById(tab).classList.remove('d-none');
    }));

    // åƒ¹æ ¼è¨­å®šé‚è¼¯
    async function fetchLatestPrice() {
      const sym = document.getElementById('symbolInput').value;
      const res = await fetch(`/api/price?symbol=${sym}`);
      const data = await res.json();
      document.getElementById('latestPrice').textContent = `${sym.toUpperCase()}: $${data.price}`;
    }
    document.getElementById('thresholdForm').addEventListener('submit', async e => {
      e.preventDefault();
      const payload = {
        symbol: document.getElementById('symbolInput').value,
        low: parseFloat(document.getElementById('lowInput').value),
        high: parseFloat(document.getElementById('highInput').value)
      };
      await fetch('/api/set-threshold', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      alert('è¨­å®šå·²æ›´æ–°ï¼');
    });
    fetchLatestPrice();
    setInterval(fetchLatestPrice, 600000);

    // äº¤æ˜“ç´€éŒ„
    async function loadTrades() {
      const res = await fetch('/api/trades');
      const trades = await res.json();
      const tbody = document.querySelector('#tradesTable tbody');
      tbody.innerHTML = '';
      trades.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.trade_time}</td>
          <td>${t.symbol}</td>
          <td>${t.side}</td>
          <td>${t.price}</td>
          <td>${t.quantity}</td>
          <td>${t.profit_pct}</td>
        `;
        tbody.append(tr);
      });
    }
    document.querySelector('[data-tab="trades"]').addEventListener('click', loadTrades);

    // æ–°èæ‘˜è¦
    async function loadNews() {
      const res = await fetch('/api/news');
      const d = await res.json();
      const container = document.getElementById('newsContainer');
      container.innerHTML = '';
      container.innerHTML += '<h5>ğŸ”— å€å¡Šéˆç†±é–€æ–‡ç« </h5>';
      d.blockchain.forEach(i => {
        const div = document.createElement('div');
        div.className = 'mb-4';
        div.innerHTML = `
          <p>${i.title}</p>
          ${i.image ? `<img src="${i.image}" style="max-width:100%;border-radius:8px;" />` : ''}
          <p><a href="${i.url}" target="_blank">é–±è®€åŸæ–‡</a></p>
        `;
        container.append(div);
      });
      container.innerHTML += '<h5>ğŸ’¹ ç¶“æ¿Ÿç†±é–€æ–‡ç« </h5>';
      d.economy.forEach(i => {
        const div = document.createElement('div');
        div.className = 'mb-4';
        div.innerHTML = `
          <p>${i.title}</p>
          ${i.image ? `<img src="${i.image}" style="max-width:100%;border-radius:8px;" />` : ''}
          <p><a href="${i.url}" target="_blank">é–±è®€åŸæ–‡</a></p>
        `;
        container.append(div);
      });
    }
    document.querySelector('[data-tab="news"]').addEventListener('click', loadNews);

    // ç­†è¨˜ç®¡ç† CRUD + å±•é–‹/ç·¨è¼¯/åˆªé™¤ï¼Œä¸¦ä¿ç•™åŸç·¨è¼¯æ ¼å¼
    const noteModal = new bootstrap.Modal(document.getElementById('noteModal'));
    document.getElementById('newNoteBtn').addEventListener('click', () => {
      document.getElementById('noteForm').reset();
      document.getElementById('noteId').value = '';
      noteModal.show();
    });

    async function loadNotes() {
      const res = await fetch('/api/notes');
      const notes = await res.json();
      const list = document.getElementById('notesList');
      list.innerHTML = '';

      notes.forEach(n => {
        // å¡ç‰‡å¤–æ¡†
        const card = document.createElement('div');
        card.className = 'card mb-2';
        card.dataset.id = n.id;

        // æ¨™é¡Œï¼‹æŒ‰éˆ•ç¾¤
        const header = document.createElement('div');
        header.className = 'card-body d-flex justify-content-between align-items-center';
        const title = document.createElement('span');
        title.textContent = n.title;
        const btnGroup = document.createElement('div');
        const btnShow = document.createElement('button');
        btnShow.className = 'btn btn-sm btn-info me-1';
        btnShow.textContent = 'é¡¯ç¤ºå…§å®¹';
        btnShow.dataset.id = n.id;
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-sm btn-primary me-1';
        btnEdit.textContent = 'ç·¨è¼¯';
        btnEdit.dataset.id = n.id;
        const btnDel = document.createElement('button');
        btnDel.className = 'btn btn-sm btn-danger';
        btnDel.textContent = 'åˆªé™¤';
        btnDel.dataset.id = n.id;
        btnGroup.append(btnShow, btnEdit, btnDel);
        header.append(title, btnGroup);
        card.append(header);

        // å…§å®¹ç´°ç¯€
        const detail = document.createElement('div');
        detail.className = 'card-body note-detail d-none';
        detail.id = `detail-${n.id}`;
        detail.style.whiteSpace = 'pre-wrap';

        // ç¨‹å¼ç¢¼å€
        const pre = document.createElement('pre');
        const codeEl = document.createElement('code');
        codeEl.textContent = n.code || '';
        pre.append(codeEl);
        detail.append(pre);

        // ç›®çš„ (ä¸‹ä¸€è¡Œé¡¯ç¤ºå…§å®¹)
        const pPurpose = document.createElement('p');
        pPurpose.innerHTML = `<strong>ç›®çš„ï¼š</strong><br>${n.purpose || ''}`;
        detail.append(pPurpose);

        // çµæœ (ä¸‹ä¸€è¡Œé¡¯ç¤ºå…§å®¹)
        const pResult = document.createElement('p');
        pResult.innerHTML = `<strong>çµæœï¼š</strong><br>${n.result || ''}`;
        detail.append(pResult);

        card.append(detail);
        list.append(card);

        // ç¶å®šæŒ‰éˆ•äº‹ä»¶
        btnShow.addEventListener('click', () => detail.classList.toggle('d-none'));
        btnEdit.addEventListener('click', () => {
          document.getElementById('noteId').value    = n.id;
          document.getElementById('noteTitle').value = n.title;
          document.getElementById('noteCode').value  = n.code;
          document.getElementById('notePurpose').value = n.purpose;
          document.getElementById('noteResult').value  = n.result;
          noteModal.show();
        });
        btnDel.addEventListener('click', async () => {
          if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è¨˜å—ï¼Ÿ')) {
            await fetch(`/api/notes/${n.id}`, { method:'DELETE' });
            loadNotes();
          }
        });
      });
    }

    document.querySelector('[data-tab="tools"]').addEventListener('click', loadNotes);

    document.getElementById('noteForm').addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('noteId').value;
      const payload = {
        title:   document.getElementById('noteTitle').value,
        code:    document.getElementById('noteCode').value,
        purpose: document.getElementById('notePurpose').value,
        result:  document.getElementById('noteResult').value
      };
      const url    = id ? `/api/notes/${id}` : '/api/notes';
      const method = id ? 'PUT' : 'POST';
      await fetch(url, {
        method,
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      noteModal.hide();
      document.querySelector('[data-tab="tools"]').click();
    });
  </script>
</body>
</html>
