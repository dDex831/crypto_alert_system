<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Alert Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <!-- 導覽列 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Crypto Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" data-tab="price" href="#">價格設定</a></li>
          <li class="nav-item"><a class="nav-link" data-tab="trades" href="#">交易紀錄</a></li>
          <li class="nav-item"><a class="nav-link" data-tab="news" href="#">新聞摘要</a></li>
          <li class="nav-item"><a class="nav-link" data-tab="tools" href="#">筆記管理</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- 價格設定區 -->
    <section id="price" class="tab-content">
      <h3>價格追蹤設定</h3>
      <form id="thresholdForm" class="row g-3">
        <div class="col-md-4">
          <label for="symbolInput" class="form-label">幣種</label>
          <input type="text" class="form-control" id="symbolInput" value="cardano">
        </div>
        <div class="col-md-4">
          <label for="lowInput" class="form-label">價格下限</label>
          <input type="number" step="0.01" class="form-control" id="lowInput" value="0.5">
        </div>
        <div class="col-md-4">
          <label for="highInput" class="form-label">價格上限</label>
          <input type="number" step="0.01" class="form-control" id="highInput" value="0.8">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">更新設定</button>
        </div>
      </form>
      <hr>
      <h5>最新價格</h5>
      <p id="latestPrice">--</p>
      <!-- TradingView 4H K 線圖 -->
      <div id="chart" style="height:400px; margin-top:1rem;"></div>
      <script src="https://s3.tradingview.com/tv.js"></script>
      <script>
        new TradingView.widget({
          container_id: 'chart',
          autosize: true,
          symbol: 'BINANCE:ADAUSDT',
          interval: '240',
          timezone: 'Asia/Taipei',
          theme: 'light',
          style: '1',
          locale: 'zh_TW',
          toolbar_bg: '#f1f3f6',
          enable_publishing: false,
          allow_symbol_change: false,
          hide_side_toolbar: false,
          details: true,
          hotlist: true
        });
      </script>
    </section>

    <!-- 交易紀錄區 -->
    <section id="trades" class="tab-content d-none">
      <h3>幣安交易紀錄</h3>
      <table class="table table-striped" id="tradesTable">
        <thead>
          <tr><th>時間</th><th>幣種</th><th>買/賣</th><th>價格</th><th>數量</th><th>獲利%</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 新聞摘要區 -->
    <section id="news" class="tab-content d-none">
      <h3>每日新聞摘要</h3>
      <div id="newsContainer"></div>
    </section>

    <!-- 筆記管理區 -->
    <section id="tools" class="tab-content d-none">
      <h3>筆記管理</h3>
      <button id="newNoteBtn" class="btn btn-success mb-3">新增筆記</button>
      <div id="notesList"></div>
    </section>
  </div>

  <!-- 筆記編輯 Modal -->
  <div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="noteModalLabel">新增 / 編輯 筆記</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="noteForm">
            <input type="hidden" id="noteId">
            <div class="mb-3">
              <label for="noteTitle" class="form-label">標題</label>
              <input type="text" class="form-control" id="noteTitle" required>
            </div>
            <div class="mb-3">
              <label for="noteCode" class="form-label">程式碼</label>
              <textarea class="form-control" id="noteCode" rows="4"></textarea>
            </div>
            <div class="mb-3">
              <label for="notePurpose" class="form-label">目的</label>
              <textarea class="form-control" id="notePurpose" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="noteResult" class="form-label">結果</label>
              <textarea class="form-control" id="noteResult" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">儲存</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle + 自訂 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 分頁切換
    document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      e.target.classList.add('active');
      const tab = e.target.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(sec => sec.classList.add('d-none'));
      document.getElementById(tab).classList.remove('d-none');
    }));

    // 價格設定邏輯
    async function fetchLatestPrice() {
      const sym = document.getElementById('symbolInput').value;
      const res = await fetch(`/api/price?symbol=${sym}`);
      const data = await res.json();
      document.getElementById('latestPrice').textContent = `${sym.toUpperCase()}: $${data.price}`;
    }
    document.getElementById('thresholdForm').addEventListener('submit', async e => {
      e.preventDefault();
      const payload = {
        symbol: document.getElementById('symbolInput').value,
        low: parseFloat(document.getElementById('lowInput').value),
        high: parseFloat(document.getElementById('highInput').value)
      };
      await fetch('/api/set-threshold', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      alert('設定已更新！');
    });
    fetchLatestPrice();
    setInterval(fetchLatestPrice, 600000);

    // 交易紀錄
    async function loadTrades() {
      const res = await fetch('/api/trades');
      const trades = await res.json();
      const tbody = document.querySelector('#tradesTable tbody');
      tbody.innerHTML = '';
      trades.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.trade_time}</td>
          <td>${t.symbol}</td>
          <td>${t.side}</td>
          <td>${t.price}</td>
          <td>${t.quantity}</td>
          <td>${t.profit_pct}</td>
        `;
        tbody.append(tr);
      });
    }
    document.querySelector('[data-tab="trades"]').addEventListener('click', loadTrades);

    // 新聞摘要
    async function loadNews() {
      const res = await fetch('/api/news');
      const d = await res.json();
      const container = document.getElementById('newsContainer');
      container.innerHTML = '';
      container.innerHTML += '<h5>🔗 區塊鏈熱門文章</h5>';
      d.blockchain.forEach(i => {
        const div = document.createElement('div');
        div.className = 'mb-4';
        div.innerHTML = `
          <p>${i.title}</p>
          ${i.image ? `<img src="${i.image}" style="max-width:100%;border-radius:8px;" />` : ''}
          <p><a href="${i.url}" target="_blank">閱讀原文</a></p>
        `;
        container.append(div);
      });
      container.innerHTML += '<h5>💹 經濟熱門文章</h5>';
      d.economy.forEach(i => {
        const div = document.createElement('div');
        div.className = 'mb-4';
        div.innerHTML = `
          <p>${i.title}</p>
          ${i.image ? `<img src="${i.image}" style="max-width:100%;border-radius:8px;" />` : ''}
          <p><a href="${i.url}" target="_blank">閱讀原文</a></p>
        `;
        container.append(div);
      });
    }
    document.querySelector('[data-tab="news"]').addEventListener('click', loadNews);

    // 筆記管理 CRUD + 展開/編輯/刪除，並保留原編輯格式
    const noteModal = new bootstrap.Modal(document.getElementById('noteModal'));
    document.getElementById('newNoteBtn').addEventListener('click', () => {
      document.getElementById('noteForm').reset();
      document.getElementById('noteId').value = '';
      noteModal.show();
    });

    async function loadNotes() {
      const res = await fetch('/api/notes');
      const notes = await res.json();
      const list = document.getElementById('notesList');
      list.innerHTML = '';

      notes.forEach(n => {
        // 卡片外框
        const card = document.createElement('div');
        card.className = 'card mb-2';
        card.dataset.id = n.id;

        // 標題＋按鈕群
        const header = document.createElement('div');
        header.className = 'card-body d-flex justify-content-between align-items-center';
        const title = document.createElement('span');
        title.textContent = n.title;
        const btnGroup = document.createElement('div');
        const btnShow = document.createElement('button');
        btnShow.className = 'btn btn-sm btn-info me-1';
        btnShow.textContent = '顯示內容';
        btnShow.dataset.id = n.id;
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-sm btn-primary me-1';
        btnEdit.textContent = '編輯';
        btnEdit.dataset.id = n.id;
        const btnDel = document.createElement('button');
        btnDel.className = 'btn btn-sm btn-danger';
        btnDel.textContent = '刪除';
        btnDel.dataset.id = n.id;
        btnGroup.append(btnShow, btnEdit, btnDel);
        header.append(title, btnGroup);
        card.append(header);

        // 內容細節
        const detail = document.createElement('div');
        detail.className = 'card-body note-detail d-none';
        detail.id = `detail-${n.id}`;
        detail.style.whiteSpace = 'pre-wrap';

        // 程式碼區
        const pre = document.createElement('pre');
        const codeEl = document.createElement('code');
        codeEl.textContent = n.code || '';
        pre.append(codeEl);
        detail.append(pre);

        // 目的 (下一行顯示內容)
        const pPurpose = document.createElement('p');
        pPurpose.innerHTML = `<strong>目的：</strong><br>${n.purpose || ''}`;
        detail.append(pPurpose);

        // 結果 (下一行顯示內容)
        const pResult = document.createElement('p');
        pResult.innerHTML = `<strong>結果：</strong><br>${n.result || ''}`;
        detail.append(pResult);

        card.append(detail);
        list.append(card);

        // 綁定按鈕事件
        btnShow.addEventListener('click', () => detail.classList.toggle('d-none'));
        btnEdit.addEventListener('click', () => {
          document.getElementById('noteId').value    = n.id;
          document.getElementById('noteTitle').value = n.title;
          document.getElementById('noteCode').value  = n.code;
          document.getElementById('notePurpose').value = n.purpose;
          document.getElementById('noteResult').value  = n.result;
          noteModal.show();
        });
        btnDel.addEventListener('click', async () => {
          if (confirm('確定要刪除此筆記嗎？')) {
            await fetch(`/api/notes/${n.id}`, { method:'DELETE' });
            loadNotes();
          }
        });
      });
    }

    document.querySelector('[data-tab="tools"]').addEventListener('click', loadNotes);

    document.getElementById('noteForm').addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('noteId').value;
      const payload = {
        title:   document.getElementById('noteTitle').value,
        code:    document.getElementById('noteCode').value,
        purpose: document.getElementById('notePurpose').value,
        result:  document.getElementById('noteResult').value
      };
      const url    = id ? `/api/notes/${id}` : '/api/notes';
      const method = id ? 'PUT' : 'POST';
      await fetch(url, {
        method,
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      noteModal.hide();
      document.querySelector('[data-tab="tools"]').click();
    });
  </script>
</body>
</html>
